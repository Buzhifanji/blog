---
title: vue3进阶笔记之pinia
date: 2022-04-20 16:12:25
permalink: /pages/a72a65/
categories:
  - 前端
  - vue
tags:
  - Javascript
  - vue
---

[Pinia](https://pinia.vuejs.org/) 是 vuex5，如果你不了了解 vuex 原理，先阅读这篇[min-vuex](18.vue3进阶笔记之vuex.md).

本文主要内容是 pinia 源码阅读笔记, 但并不是逐行阅读。本文的目的是围绕以下几个问题：

- pinia 作为插件是如何安装到vue中？
- pinia 本身插件机制是如何实现的？

## pinia 安装到vue中

安装插件的时候 provide 到 vue中。

```ts
export function createPinia(): Pinia {
  const pinia: Pinia = markRaw({
    install(app: App) { // pinia 作为插件 安裝方法
      if (!isVue2) {
        pinia._a = app
        app.provide(piniaSymbol, pinia) // 插件安裝的時候 provide pinia
        app.config.globalProperties.$pinia = pinia // 全局的 $pinia 变量配置 Pinia 对象
      }
    },
  })
  return pinia
}
```

使用的时候 inject 到组件实例中。

```ts
  function useStore(pinia?: Pinia | null, hot?: StoreGeneric): StoreGeneric {
    const currentInstance = getCurrentInstance() // 当前组件实例
    // 如果 useStrore 中没有 Pinia 的话，就使用 inject 去获取 Pinia 实例。
    // 这里 inject 的数据就是 createPinia 函数中 install 方法提供的。
    pinia =
        (__TEST__ && activePinia && activePinia._testing ? null : pinia) ||
        (currentInstance && inject(piniaSymbol))
}
```

这里实现的逻辑与[min-vue插件](18.vue3进阶笔记之vuex.md#插件安装)类似的，也是通过依赖注入来安装插件。只不过这里加入了优化，使用的使用**惰性引入**。

## pinia 插件机制

```ts
export function createPinia(): Pinia {
  let _p: Pinia['_p'] = []
  // 存储插件内容，在 install，之前使用 use 添加插件
  let toBeInstalled: PiniaPlugin[] = []

  const pinia: Pinia = markRaw({
    install(app: App) { // pinia 作为插件 安裝方法
      if (!isVue2) {
        pinia._a = app
        app.provide(piniaSymbol, pinia) // 插件安裝的時候 provide pinia
        app.config.globalProperties.$pinia = pinia // 全局的 $pinia 变量配置 Pinia 对象
 
        // 插件机制：通过 use 方法往 toBeInstalled 数组里添加插件，然后在install 的时候，遍历 toBeInstalled，存放到 Pinia 实例的 _p 属性上
        toBeInstalled.forEach((plugin) => _p.push(plugin))
        toBeInstalled = []
      }
    },
    use(plugin) {
      if (!this._a && !isVue2) {
        toBeInstalled.push(plugin) // 添加插件
      } else {
        _p.push(plugin)
      }
      return this
    },
    _p,
  })
  return pinia
}

```
通过 use 方法，把插件保存到 toBeInstalled 数组中，然后在 install 房里，把 toBeInstalled 数据赋值到 pinia 的_p 属性上。

