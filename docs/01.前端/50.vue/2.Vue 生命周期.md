---
title: Vue 生命周期
date: 2022-03-15 17:28:18
permalink: /pages/a4bbd1/
categories:
  - 前端
  - vue
tags:
  - Javascript 
  - vue
---

用文字阐述Vue完整的生命周期，解决面试的时候表示不清的问题。

本文主要有两部分，一部分是各个生命周期分别做了什么事情，另一部分是实现生命周期的实现原理。

## 完整的生命周期过程

vue完整的生命周期钩子：beforeCreate、created、beforeMount、mounted、beforeUpdate、updated、beforeDestroy、destroyed、activated、deactivated、errorCaptured、serverPrefetch。

主要四大阶段：创建、挂载、更新、销毁。另外还有一个组件缓存。

### beforeCreate 之前

beforeCreate钩子调用之前，主要做了四件事情，分别是：

- 合并组件的options
  - 子组件
    - 指定组件$options原型
    - 把组件依赖于父组件的props、listeners也挂载到options上，方便子组件调用
  - 根组件
    - 创建根组件的options

```js
const options = {
    components: {
        KeepAlive,
        Transition,
        TransitionGroup
    },
    directives: {
        model,
        show
    },
    filters: {},
    _base: Vue
}
```
- 初始化组件实例关系属性（initLifecycle），比如： $parent、$children、$root、$refs。
  
- 初始化自定义事件（initEvents），初始化的是父组件在模板中使用v-on或@注册的监听子组件内触发的事件。注意：浏览器原生事件是由父组件处理，而自定义事情交给子组件处理。

- 初始化渲染：主要是获取父组件的vnode节点和执行环境、解析插槽，以及新增组件的createElement方法。

### beforeCreate到created

beforeCreate到created这段时间做了三件事情，分别是：

- 初始化组件的 inject 配置项（initInjections）,先进行键值配对，然后添加到实例上。注意：inject绑定的数据不是响应式的，如果需要响应式的，则需要传入一个可监听的对象。

- initState：数据响应式的重点，处理 props、methods、data、computed、watch

- 解析组件配置项上的 provide 对象（initProvide），在initState之后。

### created到beforeMount

created到beforeMount这段时间主要是处理**模板编译**

首先判断是否需要编译，以及应该使用哪个一个模板。

如果vm.$options.el有数据，就会跳过编译。反之，就会进入模板编译。

模板编译的时候优先判断 render 是否存在，如果存在，就直接使用 render 函数了

如果没有，再判断 template 和 el，如果有 template，就不会管 el 了

所以优先级顺序是：**render > template > el**

因为不管是 el 挂载的，还是 template 最后都会被编译成 render 函数，而如果已经有了 render 函数了，就跳过前面的编译了

### beforeMount到mounted

beforeMount 到 mounted 这段时间做了两件事情，分别是：

- 把 vnode 渲染成真是 DOM ，并挂载。定义 updateComponent 函数，对 render 返回的虚拟 DOM 进行 patch (也就是Diff)到真实 DOM。

- 对模板中数据或状态做响应式处理，为当前组件实例设置一个观察者（Watcher），监控 updateComponent 函数得到的数据。
  
### beforeUpdate

在执行watcher.run方法之前，会执行watcher.before方法，从而执行beforeUpdate钩子函数。

注意：
- 只有视图依赖中的data发放变化，才会触发这个方法，因为没有绑定到视图的data不会被收集到依赖中。

- 此时虚拟DOM和真实DOM都还未被更新

因为虚拟DOM还没未更新，所以可以移除手动添加的事件监听器（添加时间：beforeCreate 之前，initEvents）

### beforeUpdate到updated

这段时间主要了做了一件事件，那就是开启任务队列。

每一个组件实例都有一个对应的watcher实例，watcher会在组件渲染的过程中把接触过的数据属性记录为依赖。之后，当依赖的值发生，触发setter方法，会通知watcher，此时Vue就会开启一个任务队列，并缓冲同一事情循环中发生变化的所有变更数据。如果同一个watcher被多次触发，只会被推入任务队列中一次。

### 卸载

beforeDestroy到destoryed：从父组件中删除当前组件，移除当前组件内的所有观察者(依赖追踪)，删除数据对象的引用，删除虚拟 DOM

destoryed调用之后，关闭所有事件监听，删除当前根组件的引用，删除父级的引用

## 实现原理

## 参考资料

- [Vue初始化中的选项合并之initInternalComponent详解](https://www.zhangshengrong.com/p/AvN6Y9jkam/)
- [初始化阶段(initEvents)](https://www.bookset.io/read/Learn-Vue-Source-Code/25168487fa351d90.md)
- [初始化阶段(initInjections)](https://www.bookset.io/read/Learn-Vue-Source-Code/83af4e1b85cee70d.md)